\documentclass[]{article}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
\else % if luatex or xelatex
  \ifxetex
    \usepackage{mathspec}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\usepackage[margin=1in]{geometry}
\usepackage{hyperref}
\hypersetup{unicode=true,
            pdftitle={Holocene biomes dynamic},
            pdfauthor={Vincent Pellissier},
            pdfborder={0 0 0},
            breaklinks=true}
\urlstyle{same}  % don't use monospace font for urls
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\IfFileExists{parskip.sty}{%
\usepackage{parskip}
}{% else
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{0}
% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

%%% Use protect on footnotes to avoid problems with footnotes in titles
\let\rmarkdownfootnote\footnote%
\def\footnote{\protect\rmarkdownfootnote}

%%% Change title format to be more compact
\usepackage{titling}

% Create subtitle command for use in maketitle
\newcommand{\subtitle}[1]{
  \posttitle{
    \begin{center}\large#1\end{center}
    }
}

\setlength{\droptitle}{-2em}
  \title{Holocene biomes dynamic}
  \pretitle{\vspace{\droptitle}\centering\huge}
  \posttitle{\par}
  \author{Vincent Pellissier}
  \preauthor{\centering\large\emph}
  \postauthor{\par}
  \predate{\centering\large\emph}
  \postdate{\par}
  \date{29 ao√ªt 2018}


\begin{document}
\maketitle

\section{Spatial dynamic of the biomes through the
Holocene}\label{spatial-dynamic-of-the-biomes-through-the-holocene}

While organizing a workshop on the impact of human activities on
biodiversity at different spatial scales, I realized that a good entry
point would be to illustrate how some physical features of the
environment (for example biome area, as defined as the area of a biome
not being covered by land-use) have changed through time.

\subsection{The historical land-use
dataset}\label{the-historical-land-use-dataset}

The HYDE 3.2 dataset is a well-known reconstruction of past land-use
(from the beginning of the Holocene to present day). For each time point
the percentage of each cell being cropland (divided into irrigated and
rain-fed non-rice crops and irrigated and rain-fed rice crops) or
grazing land (divided into intensive pasture and less intensive
rangeland) is modelled based on population estimates. The whole data set
comprises 67 series of maps: for each time point, a map for each of the
above land-cover was produced. In addition, at each time point, three
different population estimate are used (lower, median and upper)

\subsection{Outputs}\label{outputs}

I had two visual outputs in mind. (1) A series of chronological maps
showing the variation of the extant of each biome through time and (2) a
temporal graph of the total area for each biomes.

\subsection{Methods}\label{methods}

\subsubsection{Downloading and extracting
maps}\label{downloading-and-extracting-maps}

On the HYDE website, maps are downloadable either one by one (that is,
for each point in time, one has to select the desired population
scenario, format, date and type of land-cover) or in bulk (that is, on
.zip file per date). Neither of these options is really practical. The
first one implies clicking on each map, one by one. The second one
implies extracting the maps from the zipfile, either one by one, or
autocmatically (and having more information that is really needed). To
overcome that issue, I designed a function (compute\_non\_human()) that
computes for a given point in time and for each biome, the percentage of
each cell NOT covered by a human land-cover (i.e.~cropland and grazing
land) and saves it on a local computer.

\paragraph{Download and computation
algorithm}\label{download-and-computation-algorithm}

The code in the function is commented, but what follow is a brief
description of the algorithm and the code used to run the function:

\begin{itemize}
\tightlist
\item
  The function takes several arguments:

  \begin{itemize}
  \tightlist
  \item
    `date' is the date for which we want information,\\
  \item
    `scenario' matches the population scenario (`upper', `lower' or
    `median')\\
  \item
    `path\_save' is the local path where the maps are saved\\
  \item
    raster\_biomes' is a raster containing biome information. It matches
    the biomes shapefile found
    \href{https://www.worldwildlife.org/publications/terrestrial-ecoregions-of-the-world}{here}.
    The biomes raster can be downloaded
    \href{https://github.com/vpellissier/holocene_biomes_dynamic/raw/master/Original\%20data/biomes.tif}{here}
  \end{itemize}
\item
  The function proceed as follow:

  \begin{itemize}
  \tightlist
  \item
    It calls a subfunction (dl\_land\_use()) which download a raster of
    a land-cover for a given date in a temporary folder This
    sub-function is called three time (to download raster for cropland,
    rangeland and pastures). This webscrapping approach requires one
    extra-step, explained in more detail below.
  \item
    The 3 rasters are loaded in the R environment and added together, in
    order to create a human land-cover layer.
  \item
    For each given biome in the raster, the percentage of each cell
    belonging to this biome and NOT being human land-cover is computed.
  \item
    The output is saved as a stacked raster (one layer per biome) and
    the temporary folder is removed from the local computer
  \end{itemize}
\end{itemize}

\paragraph{Compiling raster of non human
land-cover}\label{compiling-raster-of-non-human-land-cover}

First, one need to download the biome raster in a folder (here, I use a
temporary folder) and the accompanying XML file.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(raster, }\DataTypeTok{quietly =}\NormalTok{ T)}
\KeywordTok{library}\NormalTok{(snowfall, }\DataTypeTok{quietly =}\NormalTok{ T)}
\KeywordTok{library}\NormalTok{(dplyr, }\DataTypeTok{quietly =}\NormalTok{ T)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Attaching package: 'dplyr'
\end{verbatim}

\begin{verbatim}
## The following objects are masked from 'package:raster':
## 
##     intersect, select, union
\end{verbatim}

\begin{verbatim}
## The following objects are masked from 'package:stats':
## 
##     filter, lag
\end{verbatim}

\begin{verbatim}
## The following objects are masked from 'package:base':
## 
##     intersect, setdiff, setequal, union
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(tibble, }\DataTypeTok{quietly =}\NormalTok{ T)}
\KeywordTok{library}\NormalTok{(rasterVis, }\DataTypeTok{quietly =}\NormalTok{ T)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: package 'rasterVis' was built under R version 3.5.1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(ggplot2, }\DataTypeTok{quietly =}\NormalTok{ T)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: package 'ggplot2' was built under R version 3.5.1
\end{verbatim}

\begin{verbatim}
## 
## Attaching package: 'ggplot2'
\end{verbatim}

\begin{verbatim}
## The following object is masked from 'package:latticeExtra':
## 
##     layer
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(tidyr, }\DataTypeTok{quietly =}\NormalTok{ T)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Attaching package: 'tidyr'
\end{verbatim}

\begin{verbatim}
## The following object is masked from 'package:raster':
## 
##     extract
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Downloading the biomes raster}
\NormalTok{tp <-}\StringTok{ }\KeywordTok{tempdir}\NormalTok{()}
\NormalTok{raster_url <-}\StringTok{ "https://github.com/vpellissier/holocene_biomes_dynamic/raw/master/Original%20data/biomes.tif"}
\NormalTok{xml_url <-}\StringTok{ "https://github.com/vpellissier/holocene_biomes_dynamic/raw/master/Original%20data/biomes.tif.aux.xml"}
\KeywordTok{download.file}\NormalTok{(raster_url, }\KeywordTok{file.path}\NormalTok{(tp, }\StringTok{"biomes.tif"}\NormalTok{), }\DataTypeTok{mode =} \StringTok{"wb"}\NormalTok{)}
\KeywordTok{download.file}\NormalTok{(xml_url, }\KeywordTok{file.path}\NormalTok{(tp, }\StringTok{"biomes.tif.aux.xml"}\NormalTok{), }\DataTypeTok{mode =} \StringTok{"wb"}\NormalTok{)}
\NormalTok{raster_biomes <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(}\KeywordTok{file.path}\NormalTok{(tp, }\StringTok{"biomes.tif"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

Prior to actually downloading the data, a Selenium server have to be
started, in order for R to be able to command a web-browser (here
Chrome). There is several ways to do this, but here we are going to use
a standalone server. THe server can be downloaded from the
\href{http://selenium-release.storage.googleapis.com/index.html}{Selenium
Project}. Once downloaded, the server can be started using the following
command line (either in Windows shell or in RStudio Terminal):

\texttt{\textgreater{}\ java\ \ -jar\ path/file\_name}

Where path is the path were you have downloaded the file, and file the
name of the file (should end with a .jar extension). Then, the data can
actually be downloaded and processed for the 66 dates available in the
HYDE dataset (unfortunately, dates had to be copied manually)

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dates <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"10000BC"}\NormalTok{, }\StringTok{"9000BC"}\NormalTok{, }\StringTok{"8000BC"}\NormalTok{, }\StringTok{"7000BC"}\NormalTok{, }\StringTok{"6000BC"}\NormalTok{, }\StringTok{"5000BC"}\NormalTok{, }\StringTok{"4000BC"}\NormalTok{, }\StringTok{"3000BC"}\NormalTok{,}
           \StringTok{"2000BC"}\NormalTok{, }\StringTok{"1000BC"}\NormalTok{, }\StringTok{"0AD"}\NormalTok{, }\StringTok{"500AD"}\NormalTok{, }\StringTok{"1000AD"}\NormalTok{, }\StringTok{"1100AD"}\NormalTok{, }\StringTok{"1200AD"}\NormalTok{, }\StringTok{"1300AD"}\NormalTok{, }\StringTok{"1400AD"}\NormalTok{, }
           \StringTok{"1500AD"}\NormalTok{, }\StringTok{"1600AD"}\NormalTok{, }\StringTok{"1700AD"}\NormalTok{, }\StringTok{"1710AD"}\NormalTok{, }\StringTok{"1720AD"}\NormalTok{, }\StringTok{"1730AD"}\NormalTok{,   }\StringTok{"1740AD"}\NormalTok{, }\StringTok{"1750AD"}\NormalTok{, }
           \StringTok{"1760AD"}\NormalTok{, }\StringTok{"1770AD"}\NormalTok{, }\StringTok{"1780AD"}\NormalTok{, }\StringTok{"1790AD"}\NormalTok{, }\StringTok{"1800AD"}\NormalTok{, }\StringTok{"1810AD"}\NormalTok{, }\StringTok{"1820AD"}\NormalTok{, }\StringTok{"1840AD"}\NormalTok{, }
           \StringTok{"1850AD"}\NormalTok{, }\StringTok{"1860AD"}\NormalTok{, }\StringTok{"1870AD"}\NormalTok{, }\StringTok{"1880AD"}\NormalTok{, }\StringTok{"1890AD"}\NormalTok{, }\StringTok{"1900AD"}\NormalTok{, }\StringTok{"1910AD"}\NormalTok{, }\StringTok{"1920AD"}\NormalTok{, }
           \StringTok{"1930AD"}\NormalTok{, }\StringTok{"1940AD"}\NormalTok{, }\StringTok{"1950AD"}\NormalTok{, }\StringTok{"1960AD"}\NormalTok{, }\StringTok{"1970AD"}\NormalTok{, }\StringTok{"1980AD"}\NormalTok{, }\StringTok{"1990AD"}\NormalTok{, }\StringTok{"2000AD"}\NormalTok{, }
           \StringTok{"2001AD"}\NormalTok{, }\StringTok{"2002AD"}\NormalTok{, }\StringTok{"2003AD"}\NormalTok{, }\StringTok{"2004AD"}\NormalTok{, }\StringTok{"2005AD"}\NormalTok{, }\StringTok{"2006AD"}\NormalTok{, }\StringTok{"2007AD"}\NormalTok{, }\StringTok{"2008AD"}\NormalTok{, }
           \StringTok{"2009AD"}\NormalTok{, }\StringTok{"2010AD"}\NormalTok{, }\StringTok{"2011AD"}\NormalTok{, }\StringTok{"2012AD"}\NormalTok{, }\StringTok{"2013AD"}\NormalTok{, }\StringTok{"2014AD"}\NormalTok{, }\StringTok{"2015AD"}\NormalTok{, }\StringTok{"2016AD"}\NormalTok{)}

\ControlFlowTok{for}\NormalTok{(time_point }\ControlFlowTok{in}\NormalTok{ dates)\{}
        \KeywordTok{try}\NormalTok{(}\KeywordTok{compute_non_human}\NormalTok{(date, }\StringTok{"upper"}\NormalTok{, }
\NormalTok{                      raster_biomes, }
                      \DataTypeTok{save_path =} \StringTok{"path/to/stacked_raster_folder"}\NormalTok{))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

The code presented above takes a couple of hours to finish, but the
result of the code (the data processed and saved as stacked raster) can
be found and downloaded in \href{https://goo.gl/aHhtGx}{this folder}

\subsubsection{Mapping the biome extant through
time}\label{mapping-the-biome-extant-through-time}

Here, in order to make the respresentation clearer, only the cells with
less than 50\% of their areas as human land-cover are considered as
belonging to the biome. While representing the cells with less than 50\%
of their areas as human land-cover can be done straight away with
ggplot, here, I also produced raster map that could be used in
subsequent analyses (the maps are stored \href{}{here}:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Creating maps of biome extant (one map per date and per biome, stored in separate directories)}
\KeywordTok{sapply}\NormalTok{(}\KeywordTok{seq}\NormalTok{(}\DecValTok{16}\NormalTok{), }\ControlFlowTok{function}\NormalTok{(biome_value)\{}
\NormalTok{    biome_name <-}\StringTok{ }\NormalTok{biomes_codes}\OperatorTok{$}\NormalTok{category[biomes_codes}\OperatorTok{$}\NormalTok{ID }\OperatorTok{==}\StringTok{ }\NormalTok{biome_value]}
\NormalTok{    biome_path <-}\StringTok{ }\KeywordTok{file.path}\NormalTok{(raster_path, biome_name)}
    
    \ControlFlowTok{if}\NormalTok{(}\OperatorTok{!}\KeywordTok{dir.exists}\NormalTok{(biome_path))}
        \KeywordTok{dir.create}\NormalTok{(}\DataTypeTok{path =}\NormalTok{ biome_path)}

        \KeywordTok{sapply}\NormalTok{(rasters, }\ControlFlowTok{function}\NormalTok{(r)\{}
\NormalTok{            r_date <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(}\KeywordTok{file.path}\NormalTok{(raster_path, r), }\DataTypeTok{band =}\NormalTok{ biome_value)}
            \KeywordTok{values}\NormalTok{(r_date)[}\KeywordTok{values}\NormalTok{(r_date) }\OperatorTok{<}\StringTok{ }\FloatTok{0.5}\NormalTok{] <-}\StringTok{ }\DecValTok{0}
\NormalTok{            d <-}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"biomes_"}\NormalTok{, }\StringTok{""}\NormalTok{, r)}
\NormalTok{            d <-}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{".tif"}\NormalTok{, }\StringTok{""}\NormalTok{, d)}
            \KeywordTok{writeRaster}\NormalTok{(r_date, }
                        \KeywordTok{file.path}\NormalTok{(raster_path, biome_name, }\KeywordTok{paste0}\NormalTok{(biome_name, }\StringTok{"_"}\NormalTok{, d, }\StringTok{".tif"}\NormalTok{)))}
\NormalTok{    \})}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

To illustrate the evolution of the temporal extent of biomes, only a few
stapple date are represented but the rasters are computed for all the
dates. Here, only the Temperate grassland and the Temperate forests are
represented: \includegraphics{README_files/figure-latex/figs-1.pdf}

\subsubsection{Temporal evolution of biomes area through the
Holocene}\label{temporal-evolution-of-biomes-area-through-the-holocene}

Once the stacked raster containing have been produced for each date, the
total area is computed for each biome at each point in time.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(snowfall, }\DataTypeTok{quietly =}\NormalTok{ T)}
\KeywordTok{library}\NormalTok{(dplyr, }\DataTypeTok{quietly =}\NormalTok{ T)}
\KeywordTok{library}\NormalTok{(tidyr, }\DataTypeTok{quietly =}\NormalTok{ T)}
\KeywordTok{library}\NormalTok{(tibble, }\DataTypeTok{quietly =}\NormalTok{ T)}
\KeywordTok{library}\NormalTok{(ggplot2, }\DataTypeTok{quietly =}\NormalTok{ T)}

\CommentTok{# creating a dataframe matching biomes names and numeric code (embedded in the biome raster)}
\NormalTok{biomes_codes <-}\StringTok{ }\KeywordTok{attr}\NormalTok{(raster_biomes}\OperatorTok{@}\NormalTok{data, }\StringTok{"attributes"}\NormalTok{)[[}\DecValTok{1}\NormalTok{]] }
\end{Highlighting}
\end{Shaded}

While compiling the stacked raster in not so computationnaly intensive
(a few hours), compiling the area of non human land-cover in each cell,
for each biome and at each time point is computationnally intensive.\\
In order to fasten the process, it can be parallelized (here on a single
machine)

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Assuming that the stacked raster are stored in "path/to/stacked_raster_folder"}

\NormalTok{rasters <-}\StringTok{ }\KeywordTok{dir}\NormalTok{(raster_path)}

\CommentTok{# Compiling the area of non human land-cover in each pixel for each biome at each time point}
\KeywordTok{sfInit}\NormalTok{(}\DataTypeTok{parallel=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{cpus=}\DecValTok{6}\NormalTok{)}
\KeywordTok{sfExport}\NormalTok{(}\StringTok{"raster"}\NormalTok{)}
\NormalTok{df_area_biomes <-}\StringTok{ }\KeywordTok{sfAapply}\NormalTok{(rasters, }\ControlFlowTok{function}\NormalTok{(r)\{}
\NormalTok{                    raster_area <-}\StringTok{ }\KeywordTok{area}\NormalTok{(}\KeywordTok{raster}\NormalTok{(}\KeywordTok{file.path}\NormalTok{(raster_path, r)))}
                    \KeywordTok{sapply}\NormalTok{(}\KeywordTok{seq}\NormalTok{(}\DecValTok{16}\NormalTok{), }\ControlFlowTok{function}\NormalTok{(layer)\{}
\NormalTok{                        biomes_area <-}\StringTok{ }\KeywordTok{raster}\NormalTok{(}\KeywordTok{file.path}\NormalTok{(raster_path, r), }\DataTypeTok{band =}\NormalTok{ layer) }\OperatorTok{*}\StringTok{ }\NormalTok{raster_area}
                        \KeywordTok{sum}\NormalTok{(biomes_area[], }\DataTypeTok{na.rm =}\NormalTok{ T)}
\NormalTok{                        \})}
\NormalTok{                    \})}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Adding biome names as rownames}
\KeywordTok{rownames}\NormalTok{(df_area_biomes) <-}\StringTok{ }\KeywordTok{as.character}\NormalTok{(biomes_codes}\OperatorTok{$}\NormalTok{category[}\OperatorTok{-}\DecValTok{1}\NormalTok{])}

\NormalTok{df_area_biomes <-}\StringTok{ }\KeywordTok{apply}\NormalTok{(df_area_biomes, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x)\{}
\NormalTok{                        x }\OperatorTok{/}\StringTok{ }\NormalTok{df_area_biomes[,}\KeywordTok{grep}\NormalTok{(}\StringTok{"10000BC"}\NormalTok{, }\KeywordTok{colnames}\NormalTok{(df_area_biomes))] }\OperatorTok{*}\DecValTok{100}
\NormalTok{                        \})}


\CommentTok{# Transforming the data in long table and adding a year column (using 2016 as present date)}
\CommentTok{# and removing Mangrove, Waters, Rock and Montane grasslands}
\NormalTok{df_area_long <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(}\KeywordTok{t}\NormalTok{(df_area_biomes)) }\OperatorTok{%>%}
\StringTok{                    }\KeywordTok{rownames_to_column}\NormalTok{(}\DataTypeTok{var =} \StringTok{"year_AD_BC"}\NormalTok{) }\OperatorTok{%>%}
\StringTok{                    }\KeywordTok{gather}\NormalTok{(Biome, Area, }\OperatorTok{-}\NormalTok{year_AD_BC) }\OperatorTok{%>%}
\StringTok{                    }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{year_AD_BC =} \KeywordTok{gsub}\NormalTok{(}\StringTok{"biomes_"}\NormalTok{, }\StringTok{""}\NormalTok{, year_AD_BC)) }\OperatorTok{%>%}
\StringTok{                    }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{year_AD_BC =} \KeywordTok{gsub}\NormalTok{(}\StringTok{".tif"}\NormalTok{, }\StringTok{""}\NormalTok{, year_AD_BC)) }\OperatorTok{%>%}
\StringTok{                    }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{AD_or_BC =} \KeywordTok{substr}\NormalTok{(year_AD_BC, }\KeywordTok{nchar}\NormalTok{(year_AD_BC) }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{, }\KeywordTok{nchar}\NormalTok{(year_AD_BC ))) }\OperatorTok{%>%}
\StringTok{                    }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{year_BP =} \KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{substr}\NormalTok{(year_AD_BC, }\DecValTok{1}\NormalTok{, }\KeywordTok{nchar}\NormalTok{(year_AD_BC) }\OperatorTok{-}\StringTok{ }\DecValTok{2}\NormalTok{))) }\OperatorTok{%>%}
\StringTok{                    }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{year_BP =}\NormalTok{ year_BP }\OperatorTok{*}\StringTok{ }\KeywordTok{ifelse}\NormalTok{(AD_or_BC }\OperatorTok{==}\StringTok{ "BC"}\NormalTok{, }\OperatorTok{-}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{) }\OperatorTok{-}\StringTok{ }\DecValTok{2017}\NormalTok{)}\CommentTok{# %>%}
\end{Highlighting}
\end{Shaded}

\includegraphics{README_files/figure-latex/ggplot2-1.pdf}


\end{document}
